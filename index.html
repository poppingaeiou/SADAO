<script>
    const WEB_APP_URL = "https://script.google.com/macros/s/AKfycbyQKDaHWzzb2PIuend4HS62cDD0qrGQmtFOzvKMYBzNGcv7Wj4LxVsTz_HfAmtvJbbzsA/exec"; 

    function toggleChat() {
        const win = document.getElementById('chatWindow');
        win.style.display = (win.style.display === 'flex') ? 'none' : 'flex';
        if(win.style.display === 'flex') document.getElementById('chatInput').focus();
    }

    // ฟังก์ชันจัดฟอร์แมตข้อความให้สวยงาม
    function formatText(text) {
        return text
            .replace(/\n/g, '<br>') // เว้นบรรทัด
            .replace(/\*\*(.*?)\*\*/g, '<b>$1</b>') // ตัวหนา
            .replace(/\* (.*?)/g, '• $1'); // กระสุน
    }

    function appendMessage(text, sender) {
        const body = document.getElementById('chatBody');
        const div = document.createElement('div');
        div.className = `msg msg-${sender}`;
        div.innerHTML = formatText(text); // เรียกใช้ตัวจัดฟอร์แมต
        body.appendChild(div);
        body.scrollTop = body.scrollHeight;
    }

    async function sendMessage() {
        const input = document.getElementById('chatInput');
        const text = input.value.trim();
        if(!text) return;

        appendMessage(text, 'user');
        input.value = '';
        
        const typing = document.getElementById('typingIndicator');
        typing.style.display = 'block';
        document.getElementById('chatBody').scrollTop = document.getElementById('chatBody').scrollHeight;

        try {
            const response = await fetch(WEB_APP_URL, {
                method: "POST",
                headers: { "Content-Type": "text/plain" },
                body: JSON.stringify({ message: text })
            });
            const data = await response.json();
            typing.style.display = 'none';
            appendMessage(data.reply || "ขออภัยค่ะ น้องใบบุญเกิดข้อผิดพลาดด้านเทคนิค", 'bot');
        } catch (err) {
            typing.style.display = 'none';
            appendMessage("❌ ไม่สามารถเชื่อมต่อระบบได้ในขณะนี้", 'bot');
        }
    }

    document.getElementById('chatInput').addEventListener('keypress', (e) => {
        if(e.key === 'Enter') sendMessage();
    });
</script>
